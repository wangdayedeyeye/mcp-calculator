name: Deploy to Alibaba Cloud Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy on push
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SSH extract and run deploy commands
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ vars.ALI_HOST }}
          username: ${{ vars.ALI_USER }}
          port: ${{ vars.ALI_PORT }}
          key: ${{ secrets.ALI_SSH_PRIVATE_KEY }}
          timeout: 60s
          command_timeout: 20m
          script: |
            set -Eeuo pipefail
            
            DEPLOY_PATH="${{ vars.DEPLOY_PATH }}"
            export MCP_ENDPOINT="${{ vars.MCP_ENDPOINT }}"
            export FC_TMT_API_URL="${{ vars.FC_TMT_API_URL }}"
            export FC_TMT_API_TOKEN="${{ vars.FC_TMT_API_TOKEN }}"
            
            echo "📥 更新代码..."
            cd "$DEPLOY_PATH"
            git fetch --all --quiet
            git reset --hard origin/main
            
            echo "🔧 安装依赖..."
            uv sync -i https://pypi.tuna.tsinghua.edu.cn/simple
            
            echo "🚀 重启进程..."
            LOG_FILE="logs/mcp_pipe.log"
            mkdir -p logs
            
            # ✅ 关键修改1：使用 [e] 技巧防止 pkill 杀死部署脚本自身
            # 正则 mcp_pip[e].py 匹配 "mcp_pipe.py"，但不匹配脚本中的 "mcp_pip[e].py" 字串
            pkill -f "python.*mcp_pip[e].py" || true
            
            # ✅ 关键修改2：加回 setsid，确保进程完全后台化
            nohup setsid .venv/bin/python mcp_pipe.py >> "$LOG_FILE" 2>&1 < /dev/null & 
            NEW_PID=$!
            
            sleep 3
            if kill -0 "$NEW_PID" 2>/dev/null; then
              echo "✅ 部署成功，PID: $NEW_PID"
            else
              echo "❌ 进程启动失败，日志如下："
              tail -n 50 "$LOG_FILE"
              exit 1
            fi
