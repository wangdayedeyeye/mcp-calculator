name: Deploy to Alibaba Cloud Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy on push
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SSH extract and run deploy commands
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ vars.ALI_HOST }}
          username: ${{ vars.ALI_USER }}
          port: ${{ vars.ALI_PORT }}
          key: ${{ secrets.ALI_SSH_PRIVATE_KEY }}
          timeout: 60s
          command_timeout: 20m
          script: |
            set -Eeuo pipefail
            trap 'echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¡Œå·: $LINENO"; exit 1' ERR
            DEPLOY_PATH="${{ vars.DEPLOY_PATH }}"
            MCP_ENDPOINT="${{ vars.MCP_ENDPOINT }}"
            FC_TMT_API_URL="${{ vars.FC_TMT_API_URL }}"
            FC_TMT_API_TOKEN="${{ vars.FC_TMT_API_TOKEN }}"
            : "${DEPLOY_PATH:?ç¼ºå°‘ DEPLOY_PATH}"
            : "${MCP_ENDPOINT:?ç¼ºå°‘ MCP_ENDPOINT}"
            : "${FC_TMT_API_URL:?ç¼ºå°‘ FC_TMT_API_URL}"
            : "${FC_TMT_API_TOKEN:?ç¼ºå°‘ FC_TMT_API_TOKEN}"
            cd "${DEPLOY_PATH}" || { echo "âŒ ç›®å½•ä¸å­˜åœ¨: ${DEPLOY_PATH}"; exit 1; }
            [[ -d ".git" ]] || { echo "âŒ ç›®æ ‡ç›®å½•ä¸æ˜¯ Git ä»“åº“: ${DEPLOY_PATH}"; exit 1; }
            git fetch --all --quiet || { echo "âŒ æ‹‰å–è¿œç«¯ä»£ç å¤±è´¥"; exit 1; }
            git reset --hard origin/main || { echo "âŒ é‡ç½®åˆ° origin/main å¤±è´¥"; exit 1; }
            command -v uv >/dev/null 2>&1 || { echo "âŒ æœªå®‰è£… uvï¼Œè¯·å…ˆå®‰è£…"; exit 1; }
            export MCP_ENDPOINT
            export FC_TMT_API_URL
            export FC_TMT_API_TOKEN
            echo "ğŸ”§ ä¾èµ–å®‰è£…ä¸­..."
            uv sync -i https://pypi.tuna.tsinghua.edu.cn/simple || { echo "âŒ ä¾èµ–åŒæ­¥å¤±è´¥"; exit 1; }
            [[ -x ".venv/bin/python" ]] || { echo "âŒ æœªæ‰¾åˆ°è™šæ‹Ÿç¯å¢ƒè§£é‡Šå™¨: .venv/bin/python"; exit 1; }
            source .venv/bin/activate
            [[ -f "mcp_pipe.py" ]] || { echo "âŒ æœªæ‰¾åˆ°å¯åŠ¨è„šæœ¬: mcp_pipe.py"; exit 1; }
            echo "ğŸš€ æ­£åœ¨é‡å¯æœåŠ¡..."
            sudo systemctl restart mcp_pipe || { echo "âŒ é‡å¯ mcp_pipe å¤±è´¥"; sudo systemctl status mcp_pipe --no-pager; exit 1; }
            systemctl is-active --quiet mcp_pipe || { echo "âŒ mcp_pipe æœªå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œæœ€è¿‘æ—¥å¿—ï¼š"; sudo journalctl -u mcp_pipe --no-pager -n 200; exit 1; }
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼ŒæœåŠ¡çŠ¶æ€ï¼š"
            sudo systemctl status mcp_pipe --no-pager
