name: Deploy to Alibaba Cloud Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy on push
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SSH extract and run deploy commands
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ vars.ALI_HOST }}
          username: ${{ vars.ALI_USER }}
          port: ${{ vars.ALI_PORT }}
          key: ${{ secrets.ALI_SSH_PRIVATE_KEY }}
          timeout: 60s
          command_timeout: 20m
          script: |
            set -Eeuo pipefail
            
            DEPLOY_PATH="${{ vars.DEPLOY_PATH }}"
            export MCP_ENDPOINT="${{ vars.MCP_ENDPOINT }}"
            export FC_TMT_API_URL="${{ vars.FC_TMT_API_URL }}"
            export FC_TMT_API_TOKEN="${{ vars.FC_TMT_API_TOKEN }}"
            
            echo "üì• Êõ¥Êñ∞‰ª£Á†Å..."
            cd "$DEPLOY_PATH"
            git fetch --all --quiet
            git reset --hard origin/main
            
            echo "üîß ÂÆâË£Ö‰æùËµñ..."
            uv sync -i https://pypi.tuna.tsinghua.edu.cn/simple
            