name: Deploy to Alibaba Cloud Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy on push
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SSH extract and run deploy commands
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ vars.ALI_HOST }}
          username: ${{ vars.ALI_USER }}
          port: ${{ vars.ALI_PORT }}
          key: ${{ secrets.ALI_SSH_PRIVATE_KEY }}
          timeout: 60s
          command_timeout: 20m
          script: |
            set -Eeuo pipefail
            trap 'echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¡Œå·: $LINENO"; exit 1' ERR
            DEPLOY_PATH="${{ vars.DEPLOY_PATH }}"
            MCP_ENDPOINT="${{ vars.MCP_ENDPOINT }}"
            FC_TMT_API_URL="${{ vars.FC_TMT_API_URL }}"
            FC_TMT_API_TOKEN="${{ vars.FC_TMT_API_TOKEN }}"
            : "${DEPLOY_PATH:?ç¼ºå°‘ DEPLOY_PATH}"
            : "${MCP_ENDPOINT:?ç¼ºå°‘ MCP_ENDPOINT}"
            : "${FC_TMT_API_URL:?ç¼ºå°‘ FC_TMT_API_URL}"
            : "${FC_TMT_API_TOKEN:?ç¼ºå°‘ FC_TMT_API_TOKEN}"
            cd "${DEPLOY_PATH}" || { echo "âŒ ç›®å½•ä¸å­˜åœ¨: ${DEPLOY_PATH}"; exit 1; }
            [[ -d ".git" ]] || { echo "âŒ ç›®æ ‡ç›®å½•ä¸æ˜¯ Git ä»“åº“: ${DEPLOY_PATH}"; exit 1; }
            git fetch --all --quiet || { echo "âŒ æ‹‰å–è¿œç«¯ä»£ç å¤±è´¥"; exit 1; }
            git reset --hard origin/main || { echo "âŒ é‡ç½®åˆ° origin/main å¤±è´¥"; exit 1; }
            command -v uv >/dev/null 2>&1 || { echo "âŒ æœªå®‰è£… uvï¼Œè¯·å…ˆå®‰è£…"; exit 1; }
            export MCP_ENDPOINT
            export FC_TMT_API_URL
            export FC_TMT_API_TOKEN
            echo "ğŸ”§ ä¾èµ–å®‰è£…ä¸­..."
            uv sync -i https://pypi.tuna.tsinghua.edu.cn/simple || { echo "âŒ ä¾èµ–åŒæ­¥å¤±è´¥"; exit 1; }
            [[ -x ".venv/bin/python" ]] || { echo "âŒ æœªæ‰¾åˆ°è™šæ‹Ÿç¯å¢ƒè§£é‡Šå™¨: .venv/bin/python"; exit 1; }
            source .venv/bin/activate
            [[ -f "mcp_pipe.py" ]] || { echo "âŒ æœªæ‰¾åˆ°å¯åŠ¨è„šæœ¬: mcp_pipe.py"; exit 1; }
            echo "ğŸš€ æ­£åœ¨é‡å¯è¿›ç¨‹..."
            LOG_DIR="logs"
            PID_FILE="mcp_pipe.pid"
            LOG_FILE="$LOG_DIR/mcp_pipe.log"
            mkdir -p "$LOG_DIR"
            if [[ -f "$PID_FILE" ]]; then
              OLD_PID="$(cat "$PID_FILE" || true)"
              if [[ -n "${OLD_PID:-}" ]] && kill -0 "$OLD_PID" 2>/dev/null; then
                echo "ğŸ”´ ç»ˆæ­¢æ—§è¿›ç¨‹: $OLD_PID"
                kill "$OLD_PID"
                sleep 2
                if kill -0 "$OLD_PID" 2>/dev/null; then
                  echo "âš ï¸ æ—§è¿›ç¨‹æœªé€€å‡ºï¼Œå¼ºåˆ¶æ€æ­»"
                  kill -9 "$OLD_PID"
                fi
              fi
              rm -f "$PID_FILE"
            fi
            pkill -f "python.*mcp_pipe.py" || true
            nohup .venv/bin/python mcp_pipe.py >> "$LOG_FILE" 2>&1 & echo $! > "$PID_FILE"
            NEW_PID="$(cat "$PID_FILE" || true)"
            sleep 1
            if [[ -n "${NEW_PID:-}" ]] && kill -0 "$NEW_PID" 2>/dev/null; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼ŒPID: $NEW_PID"
            else
              echo "âŒ è¿›ç¨‹æœªå¯åŠ¨ï¼Œæœ€è¿‘æ—¥å¿—ï¼š"
              tail -n 200 "$LOG_FILE" || true
              exit 1
            fi
            echo "âœ… è¿›ç¨‹çŠ¶æ€ï¼š"
            ps -o pid,cmd -p "$NEW_PID" || true
            echo "ğŸ“„ æœ€è¿‘æ—¥å¿—ï¼š"
            tail -n 50 "$LOG_FILE" || true
