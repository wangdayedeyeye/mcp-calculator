name: Deploy to Alibaba Cloud Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy on push
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create release archive
        run: |
          # æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œå‡å°ä¼ è¾“ä½“ç§¯
          tar -czf release.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            .

      - name: Upload archive to remote server (SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ vars.ALI_HOST }}
          username: ${{ vars.ALI_USER }}
          port: ${{ vars.ALI_PORT }}
          key: ${{ secrets.ALI_SSH_PRIVATE_KEY }}
          source: "release.tar.gz"
          target: ${{ vars.DEPLOY_PATH }}

      - name: SSH extract and run deploy commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.ALI_HOST }}
          username: ${{ vars.ALI_USER }}
          port: ${{ vars.ALI_PORT }}
          key: ${{ secrets.ALI_SSH_PRIVATE_KEY }}
          timeout: 60s
          command_timeout: 20m
          script: |
            # 1. ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨å¹¶è¿›å…¥
            mkdir -p "${{ vars.DEPLOY_PATH }}"
            cd "${{ vars.DEPLOY_PATH }}"
            
            # 2. è§£å‹æ–‡ä»¶ï¼ˆè¿™æ˜¯ä¹‹å‰ç¼ºå¤±çš„å…³é”®æ­¥éª¤ï¼ï¼‰
            echo "ğŸ“¦ Extracting files..."
            tar -xzf release.tar.gz
            
            # 3. å®‰è£…/åŒæ­¥ä¾èµ– (å‡è®¾æœåŠ¡å™¨å·²å®‰è£… uv)
            echo "ğŸ”§ Syncing dependencies..."
            uv sync --frozen --no-install-project -i https://pypi.tuna.tsinghua.edu.cn/simple
            source .venv/bin/activate
            
            # 5. è®¾ç½®ç¯å¢ƒå˜é‡å¹¶å¯åŠ¨æ–°è¿›ç¨‹
            # export MCP_ENDPOINT="${{ vars.MCP_ENDPOINT }}"
            
            echo "ğŸš€ Starting new process..."
            sudo systemctl restart mcp-pipe
            sudo systemctl status mcp-pipe --no-pager

      - name: Cleanup local archive
        if: always()
        run: rm -f release.tar.gz

# é…ç½®è¯´æ˜ï¼š
# 1. å¿…é¡»ç¡®ä¿ secrets.ALI_SSH_PRIVATE_KEY åŒ…å«å®Œæ•´çš„ "-----BEGIN RSA PRIVATE KEY-----" å¤´å°¾ã€‚
# 2. vars.DEPLOY_PATH ç»“å°¾æœ€å¥½ä¸å¸¦æ–œæ ï¼Œä¾‹å¦‚: /home/admin/mcp-servers/xiaozhi-mcp
# 3. å¦‚æœæœåŠ¡å™¨æœªå®‰è£… `uv`ï¼Œè„šæœ¬é‡Œçš„ fallback é€»è¾‘ä¼šå°è¯•ç”¨æ ‡å‡† pipã€‚
